<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-05-18 Mon 13:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Making and Slaying Monster Sudoku</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Kevin M. Stout" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel='stylesheet' type='text/css' href='/css/syntax.css'>
	 <link rel='stylesheet' type='text/css' href='/css/main.css'>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">

<div class='site-header'>
  <a class='site-title' href='/'>R E I N D E E R E F F E C T</a>
  <div class='nav' style='float:right;'>
    <a class='page-link' href='/about.html'>About</a>&nbsp;
    <a class='page-link' href='/links.html'>Links</a>&nbsp;
    <a class='page-link' href='/tags.html'>Tags</a>
  </div>
  <hr style='height:0.5px'>
</div>
<div class='post-head'>
  <div class='post-pubdate'>2020-05-05</div>
  <h1 class='title'>Making and Slaying Monster Sudoku</h1>
</div>
</div>
<div id="content">
<div id="text-table-of-contents">
<ul>
<li><a href="#org11069ef">1. Introduction</a></li>
<li><a href="#orgf4c0f8b">2. The Board</a>
<ul>
<li><a href="#org9146e55">2.1. Board Divisions</a></li>
<li><a href="#org7d6a35b">2.2. Logical Representation</a></li>
<li><a href="#orgc108e25">2.3. Textual Representation</a>
<ul>
<li><a href="#org1d7ed78">2.3.1. Converting from Strings</a></li>
<li><a href="#orgcb752cb">2.3.2. Converting to Strings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbfa0b4b">3. Solving Sudoku</a>
<ul>
<li><a href="#org503cb5c">3.1. Deductive Techniques</a>
<ul>
<li><a href="#org119a49a">3.1.1. Single Candidate/Naked Single</a></li>
<li><a href="#orgb287a01">3.1.2. Single Placement/Hidden Single</a></li>
<li><a href="#org2c24436">3.1.3. Rule of Exclusion</a></li>
<li><a href="#org3c12187">3.1.4. Combining Strategies</a></li>
</ul>
</li>
<li><a href="#org2d0cee5">3.2. Searching</a></li>
</ul>
</li>
<li><a href="#orgbfb7914">4. Generating Sudoku</a></li>
<li><a href="#org1514f2b">5. Utility Library</a></li>
<li><a href="#orgf92393f">6. Command Line Tools</a>
<ul>
<li><a href="#orgfedb56d">6.1. The Solver</a></li>
<li><a href="#org936aac9">6.2. The Generator</a></li>
<li><a href="#org7bc017a">6.3. The Formatter</a>
<ul>
<li><a href="#orgbe47025">6.3.1. Conversion to Latex</a></li>
<li><a href="#orgf7bf23b">6.3.2. The Latex Package</a></li>
<li><a href="#org76b4ebf">6.3.3. Converting Boards to Images</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org948873e">7. Putting It All Together</a></li>
<li><a href="#org16c1760">8. Performance</a>
<ul>
<li><a href="#org7d15ae2">8.1. Generating Puzzles</a></li>
<li><a href="#orgcc2e551">8.2. Solving</a></li>
</ul>
</li>
<li><a href="#org35b795b">9. Wrapping Up</a></li>
</ul>
</div>
<div class="abstract">
<p>
If you have a taste for NP-completeness, Sudoku, or literate programming, then
this one&rsquo;s for you.
</p>

</div>

<p>
<i>All of the code described in this article is available <a href="https://github.com/reindeereffect/reindeereffect.github.io/tree/master/2020/05/05">here</a>.</i>
</p>

<div id="outline-container-org11069ef" class="outline-2">
<h2 id="org11069ef"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Quarantine is in full swing, and after watching a disturbing amount of TV, you
plowed through a book of Sudoku puzzles that turned up in the basement. Now
they&rsquo;re gone, and you&rsquo;re looking for something more. Bigger. Monstrous, you
might say. Unfortunately, the giant Sudoku puzzles (think 16&times;16 or
25&times;25) are not quite so easy to find in any quantity. It turns out,
though, that with a little effort, you can make machines churn them out while
you sleep.
</p>

<p>
In this article we will
</p>
<ul class="org-ul">
<li>consider the structure of the Sudoku board;</li>
<li>use that structure to capture, in a general way, common heuristics for
solving Sudoku puzzles;</li>
<li>employ both constraint propagation and backtracking to create a suitably
fast Sudoku solver; and</li>
<li>use that solver as building block for generating Sudoku puzzles of any size
we might desire.</li>
</ul>

<p>
By the end, we&rsquo;ll have implemented a library for dealing with Sudoku, as well
as a small collection of command line tools for generating, solving, and
formatting puzzles.
</p>
</div>
</div>

<div id="outline-container-orgf4c0f8b" class="outline-2">
<h2 id="orgf4c0f8b"><span class="section-number-2">2</span> The Board</h2>
<div class="outline-text-2" id="text-2">
<p>
Before endeavoring to operate on Sudoku boards, we should first pin down some
useful representations, as well as conversions between them.
</p>
</div>

<div id="outline-container-org9146e55" class="outline-3">
<h3 id="org9146e55"><span class="section-number-3">2.1</span> Board Divisions</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The classic Sudoku board consists of a 9&times;9 grid of cells, with a
3&times;3 grid of boxes, each containing a 3&times;3 grid of cells, overlaid:
</p>


<div class="figure">
<p><img src="images/cells.png" alt="cells.png" />
</p>
</div>


<p>
where the cells have been numbered in row-major order. Each cell is a member of
a set of three divisions, namely 
</p>

<ul class="org-ul">
<li>rows:</li>
</ul>


<div class="figure">
<p><img src="images/row-divs.png" alt="row-divs.png" />
</p>
</div>

<ul class="org-ul">
<li>columns:</li>
</ul>


<div class="figure">
<p><img src="images/col-divs.png" alt="col-divs.png" />
</p>
</div>

<ul class="org-ul">
<li>boxes:</li>
</ul>


<div class="figure">
<p><img src="images/box-divs.png" alt="box-divs.png" />
</p>
</div>

<p>
Of these, the most interesting division of the board is into boxes. The board
board can be viewed as a 3&times;3 grid of boxes, each a 3&times;3 grid of
cells, resulting in a grid of 3<sup>4</sup> cells arranged into 3<sup>2</sup> rows and 3<sup>2</sup>
columns, for a grand total of 3&times;3<sup>2</sup> distinct divisions. When the board
is complete, each cell will contain a number from 1 to 9 (or 3<sup>2</sup>)
inclusive. Every interesting dimension is describable in terms of powers of
3, which we can think of as the <i>order</i> of a standard board. We can now think
of Sudoku (or Sudoku-like) boards a bit more generally. Given a board of
order \(\omega\), for any cell \(c\in [1, \omega^4]\), we can find the row number
\(I\) as
</p>

<p>
\[I(c) = \left\lfloor\frac{c}{\omega^2}\right\rfloor\]
</p>

<p>
the column number \(J\) as
</p>

<p>
\[J(c) = c\bmod \omega^2\]
</p>

<p>
and the box number \(B\) as
</p>

<p>
\[B(c) = \omega\times\left\lfloor\frac{I(c)}{\omega}\right\rfloor + \left\lfloor\frac{J(c)}{\omega}\right\rfloor.\]
</p>

<p>
This generalization allows us to handle larger boards with ease. For
simplicity, the discussion and examples below will center on conventional order
3 boards unless otherwise specified; even so, the principles remain the same
for other orders.
</p>

<p>
If we sequentially number divisions like
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">division</th>
<th scope="col" class="org-left">start</th>
<th scope="col" class="org-left">end</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">rows</td>
<td class="org-left">0</td>
<td class="org-left">\(\omega^2 - 1\)</td>
</tr>

<tr>
<td class="org-left">columns</td>
<td class="org-left">\(\omega^2\)</td>
<td class="org-left">\(2\omega^2 - 1\)</td>
</tr>

<tr>
<td class="org-left">boxes</td>
<td class="org-left">\(2\omega^2\)</td>
<td class="org-left">\(3\omega^2 - 1\)</td>
</tr>
</tbody>
</table>

<p>
then we can write a function to compute a mapping from cells to divisions, as
well as an inverse mapping from divisions to cells:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org659cd26"><div id='functions'>&langle;<span class='noweb-def' id='functions-4015'>functions</span>&rangle; &equiv; <span class='chunk-chain'><a href='#functions-4589'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">board_divs</span>(order):
      <span class="org-doc">'''</span>
  <span class="org-doc">    generates a dictionary (cell2divs) mapping cells to their various divisions </span>
  <span class="org-doc">    in boards of the given order. Also generates a complementary mapping, </span>
  <span class="org-doc">    div2cells. Returns (cell2divs, div2cells).</span>
  <span class="org-doc">    '''</span>
      <span class="org-variable-name">n</span> = order**2
      <span class="org-variable-name">box</span> = <span class="org-keyword">lambda</span> i, j: i//order * order + j//order
      <span class="org-variable-name">cell2divs</span> = <span class="org-builtin">dict</span>(<span class="org-builtin">enumerate</span>({i,
                                  n + j,
                                  2*n + box(i, j)}
                                 <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n)
                                 <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n)))
  
      <span class="org-keyword">return</span> cell2divs, transpose(cell2divs)</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgd582c77"><div id='functions-4589'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-4015'>&uarr;</a><a href='#functions-9675'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">transpose</span>(m):
      <span class="org-doc">'''</span>
  <span class="org-doc">    given a binary matrix represented as a dictionary whose values are sets,</span>
  <span class="org-doc">    and where a 1 at (i,j) is indicated by</span>
  
  <span class="org-doc">        j in m[i]</span>
  
  <span class="org-doc">    return the transpose of m.</span>
  <span class="org-doc">    '''</span>
      <span class="org-variable-name">t</span> = {}
      <span class="org-keyword">for</span> i, js <span class="org-keyword">in</span> m.items():
          <span class="org-keyword">for</span> j <span class="org-keyword">in</span> js:
              t.setdefault(j, <span class="org-builtin">set</span>()).add(i)
  
      <span class="org-keyword">return</span> t</pre>
</div>

<p>
Besides allowing more concise expression of algorithms operating on Sudoku
boards, thinking in terms of cells and divisions opens the door to adapting
some of what we develop here to Sudoku variants featuring irregularly-shaped
divisions (like <a href="http://www.dailysudoku.com/sudoku/archive.shtml?type=squiggly">squiggly Sudoku</a>).
</p>
</div>
</div>

<div id="outline-container-org7d6a35b" class="outline-3">
<h3 id="org7d6a35b"><span class="section-number-3">2.2</span> Logical Representation</h3>
<div class="outline-text-3" id="text-2-2">
<p>
We&rsquo;ll need a convenient representation of the board state at any given time,
as well as a ways to sensibly change that state. For that, we&rsquo;ll define a
simple class:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org0b05e41"><div id='data types'>&langle;<span class='noweb-def' id='data types-5525'>data types</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">class</span> <span class="org-type">board</span>:
      <span class="org-doc">'Utility class for representing and tracking board state.'</span>
  
      &langle;<a class='noweb-ref' href='#board initialization'>board initialization</a>&rangle;
      &langle;<a class='noweb-ref' href='#cell marking'>cell marking</a>&rangle;
      &langle;<a class='noweb-ref' href='#copying'>copying</a>&rangle;</pre>
</div>

<p>
Each cell is either known or unknown. For the known cells, we need only track
their values. For the unknown cells, however, we need to either track or
compute the values that they may possibly take. Since the requirements for
the two cell classes are different, we handle them separately.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgb18b2ba"><div id='board initialization'>&langle;<span class='noweb-def' id='board initialization-6043'>board initialization</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>, known, unknown, cell2divs, div2cells):
      <span class="org-doc">'''</span>
  <span class="org-doc">    known   dictionary mapping known cells to their respective values</span>
  <span class="org-doc">    unknown dictionary mapping unknown cells to sets of possible values</span>
  
  <span class="org-doc">    cell2divs, div2cells</span>
  <span class="org-doc">            complementary mappings describing the board structure, such as those</span>
  <span class="org-doc">            produced by board_divs</span>
  <span class="org-doc">    '''</span>
      <span class="org-keyword">assert</span> <span class="org-keyword">not</span> <span class="org-builtin">set</span>(known) &amp; <span class="org-builtin">set</span>(unknown)
      <span class="org-keyword">self</span>.known = known
      <span class="org-keyword">self</span>.unknown = unknown
      <span class="org-keyword">self</span>.cell2divs = cell2divs
      <span class="org-keyword">self</span>.div2cells = div2cells</pre>
</div>

<p>
Solving a Sudoku involves repeatedly <i>marking</i> the board until no empty cells
remain, subject to the constraint that each division contains one each of the
numbers from 1 to 9 inclusive. With each marking, we assert knowledge about a
previously unknown cell, and the possible values that can be taken by unknown
cells sharing a division become more constrained. To track this,
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3521edc"><div id='cell marking'>&langle;<span class='noweb-def' id='cell marking-7040'>cell marking</span>&rangle; &equiv; <span class='chunk-chain'><a href='#cell marking-8030'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">mark</span>(<span class="org-keyword">self</span>, cell, val):
      <span class="org-doc">'set cell to val, updating unknowns as necessary'</span>
      <span class="org-keyword">self</span>.known[cell] = val
      <span class="org-keyword">self</span>.unknown.pop(cell, <span class="org-constant">None</span>)
  
      <span class="org-keyword">for</span> div <span class="org-keyword">in</span> <span class="org-keyword">self</span>.cell2divs[cell]:
          <span class="org-keyword">for</span> cell2 <span class="org-keyword">in</span> <span class="org-keyword">self</span>.div2cells[div]:
              <span class="org-keyword">self</span>.elim(cell2, val)
  
  <span class="org-keyword">def</span> <span class="org-function-name">elim</span>(<span class="org-keyword">self</span>, cell, val):
      <span class="org-doc">"remove val from cell's possibilities"</span>
      <span class="org-keyword">self</span>.unknown.get(cell, <span class="org-builtin">set</span>()).discard(val)</pre>
</div>

<p>
This is the basic mechanism of <i>constraint propagation</i> that ultimately allows
us to develop usefully fast solution techniques. For brevity, whenever we speak
of marking a cell, we&rsquo;ll assume that the possibilities for other cells are
updated as necessary, too.
</p>

<p>
Sometimes we may not know that a given marking will work out&#x2014;perhaps we&rsquo;re
guessing&#x2014;so we should support marking cells speculatively and recovering when
we realize how wrong we are. The simplest method is to mark a copy of the
current board state:  
</p>

<div class="org-src-container">
<pre class="src src-python" id="org0fd9bd2"><div id='cell marking-8030'>&langle;<a href='#cell marking' class='noweb-ref'>cell marking</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#cell marking-7040'>&uarr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">marked</span>(<span class="org-keyword">self</span>, cell, val):
      <span class="org-doc">'returns a new board, with cell marked as val and possibilities eliminated'</span>
      <span class="org-variable-name">new</span> = <span class="org-keyword">self</span>.copy()
      new.mark(cell, val)
      <span class="org-keyword">return</span> new</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgeee7e46"><div id='imports'>&langle;<span class='noweb-def' id='imports-8275'>imports</span>&rangle; &equiv; <span class='chunk-chain'><a href='#imports-16211'>&darr;</a></span></div>  <span class="org-keyword">import</span> copy</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org483ad96"><div id='copying'>&langle;<span class='noweb-def' id='copying-8345'>copying</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">copy</span>(<span class="org-keyword">self</span>):
      <span class="org-doc">'copies board'</span>
      <span class="org-keyword">return</span> <span class="org-keyword">self</span>.__class__(copy.deepcopy(<span class="org-keyword">self</span>.known),
                            copy.deepcopy(<span class="org-keyword">self</span>.unknown),
                            <span class="org-keyword">self</span>.cell2divs,
                            <span class="org-keyword">self</span>.div2cells)</pre>
</div>
</div>
</div>

<div id="outline-container-orgc108e25" class="outline-3">
<h3 id="orgc108e25"><span class="section-number-3">2.3</span> Textual Representation</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Humans hardly want to look at Python dictionaries when there are better
representations available, so let&rsquo;s work out a textual representation for our
boards, and let&rsquo;s make it flexible enough to handle boards of any order.
</p>
</div>

<div id="outline-container-org1d7ed78" class="outline-4">
<h4 id="org1d7ed78"><span class="section-number-4">2.3.1</span> Converting from Strings</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
We&rsquo;ll impose the following requirements on strings that represent Sudoku boards
of any order \(\omega\):
</p>

<ul class="org-ul">
<li>Each cell will be represented by an integer (if known) or a &rsquo;.&rsquo; (if unknown).</li>
<li>The number of cells must be \(\omega^4\), where \(\omega\) is some integer.</li>
<li>Cells can be separated by any other character.</li>
<li>Values for known cells must be in \([1, \omega^2]\).</li>
</ul>

<p>
These rules will allow us to handle
</p>

<pre class="example">
1 3 | . .
. . | 3 1
----+----
3 1 | . .
. 2 | 1 3
</pre>

<p>
as easily as 
</p>

<pre class="example">
1 3 . .
. . 3 1
3 1 . .
. 2 1 3
</pre>

<p>
or
</p>

<pre class="example">
1 3 . . . . 3 1 3 1 . . . 2 1 3
</pre>

<p>
They also allow us to compute the order directly from the number of cells.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org41679e6"><div id='functions-9675'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-4589'>&uarr;</a><a href='#functions-10728'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">load_board</span>(s, validate_vals=<span class="org-constant">True</span>):
      <span class="org-doc">'''</span>
  <span class="org-doc">    given a string representing a board, returns a board object. For a board of</span>
  <span class="org-doc">    a given order:</span>
  
  <span class="org-doc">    - Order is computed as the fourth root of board length, and it must be an </span>
  <span class="org-doc">      integer.</span>
  
  <span class="org-doc">    - Each cell must be represented by an integer in [1, order**2] inclusive, </span>
  <span class="org-doc">      or `.' to denote unknown cells. This check can be disabled by setting</span>
  <span class="org-doc">      validate_vals to False.</span>
  
  <span class="org-doc">    - Cells must be separated from each other by any sequences of characters in</span>
  <span class="org-doc">      /[^0-9.]+/.</span>
  
  <span class="org-doc">    On failure, raises ValueError.</span>
  <span class="org-doc">    '''</span>
  
      <span class="org-variable-name">vals</span> = [cell
              <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> <span class="org-string">''</span>.join(c <span class="org-keyword">if</span> c <span class="org-keyword">in</span> <span class="org-string">'0123456789.'</span> <span class="org-keyword">else</span> <span class="org-string">' '</span>
                                  <span class="org-keyword">for</span> c <span class="org-keyword">in</span> s).strip().split()
              <span class="org-keyword">if</span> cell.isdigit() <span class="org-keyword">or</span> cell == <span class="org-string">'.'</span>]
  
      <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>(<span class="org-builtin">len</span>(vals) ** 0.25)
      <span class="org-variable-name">n</span> = order**2
      <span class="org-keyword">if</span> <span class="org-builtin">len</span>(vals) != order**4: <span class="org-keyword">raise</span> <span class="org-type">ValueError</span>
  
      <span class="org-variable-name">bd</span> = blank(order)
  
      <span class="org-keyword">for</span> (cell, val_) <span class="org-keyword">in</span> <span class="org-builtin">enumerate</span>(vals):
          <span class="org-keyword">if</span> val_ == <span class="org-string">'.'</span>: <span class="org-keyword">continue</span>
          <span class="org-variable-name">val</span> = <span class="org-builtin">int</span>(val_)
          <span class="org-keyword">if</span> validate_vals <span class="org-keyword">and</span> (val &lt; 1 <span class="org-keyword">or</span> val &gt; n): <span class="org-keyword">raise</span> <span class="org-type">ValueError</span>
          bd.mark(cell, val)
  
      <span class="org-keyword">return</span> bd</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9b3e998"><div id='functions-10728'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-9675'>&uarr;</a><a href='#functions-11172'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">blank</span>(order):
    <span class="org-doc">'generate a blank board'</span>
    <span class="org-variable-name">n</span> = order**2
    <span class="org-variable-name">possible_vals</span> = <span class="org-builtin">set</span>(<span class="org-builtin">range</span>(1, n + 1))
    <span class="org-keyword">return</span> board({},
                 {i:<span class="org-builtin">set</span>(possible_vals) <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n**2)},
                 *board_divs(order))</pre>
</div>

<p>
It would also be good know whether a board brought in from the outside world is
indeed valid, in the sense of having no conflicting cell values in any division.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org0e0358f"><div id='functions-11172'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-10728'>&uarr;</a><a href='#functions-12400'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">isvalid</span>(bd):
      <span class="org-doc">'''</span>
  <span class="org-doc">    returns True if</span>
  <span class="org-doc">    - no known cells' values conflict</span>
  <span class="org-doc">    - no unknown cell's possibilities conflict with any known cell's value</span>
  <span class="org-doc">    '''</span>
      <span class="org-keyword">return</span> <span class="org-keyword">not</span> <span class="org-builtin">any</span>(val0 <span class="org-keyword">in</span> {bd.known.get(cell)} | bd.unknown.get(cell, <span class="org-builtin">set</span>())
                     <span class="org-keyword">for</span> (cell0, val0) <span class="org-keyword">in</span> bd.known.items()
                     <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> neighbors(bd, cell0)
                     <span class="org-keyword">if</span> cell <span class="org-keyword">in</span> bd.known <span class="org-keyword">and</span> cell != cell0)
  
  <span class="org-keyword">def</span> <span class="org-function-name">neighbors</span>(bd, cell0):
      <span class="org-keyword">return</span> union(bd.div2cells[div] <span class="org-keyword">for</span> div <span class="org-keyword">in</span> bd.cell2divs[cell0])
  
  <span class="org-keyword">def</span> <span class="org-function-name">union</span>(xss):
      <span class="org-keyword">return</span> {x <span class="org-keyword">for</span> xs <span class="org-keyword">in</span> xss <span class="org-keyword">for</span> x <span class="org-keyword">in</span> xs}</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb752cb" class="outline-4">
<h4 id="orgcb752cb"><span class="section-number-4">2.3.2</span> Converting to Strings</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
Once we&rsquo;ve solved a puzzle or otherwise modified a board, we&rsquo;d like to get a
readable representation back out. Given that there are further use cases for a
completed Sudoku board, like deriving Sudoku puzzles of varying difficulty, it
should be loadable via <code>load_board</code>, like:
</p>

<pre class="example">
8 3 7 | 1 2 6 | 9 5 4
9 5 4 | 3 8 7 | 1 6 2
2 1 6 | 4 5 9 | 3 7 8
------+-------+------
7 . 9 | . 4 5 | 8 1 3
3 4 5 | 9 1 8 | 6 2 7
1 . 8 | . 7 3 | 4 9 5
------+-------+------
4 8 1 | 5 6 2 | 7 . 9
5 9 3 | 7 . 1 | 2 8 6
6 7 2 | 8 9 4 | 5 3 1
</pre>

<div class="org-src-container">
<pre class="src src-python" id="org7c88d24"><div id='functions-12400'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-11172'>&uarr;</a><a href='#functions-14163'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">dump_board</span>(bd):
      <span class="org-doc">'returns a "pretty printed" string representation of board bd'</span>
      <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>((<span class="org-builtin">len</span>(bd.known) + <span class="org-builtin">len</span>(bd.unknown)) ** 0.25)
      <span class="org-variable-name">n</span> = order**2
  
      <span class="org-variable-name">svals</span> = [<span class="org-builtin">str</span>(bd.known[i] <span class="org-keyword">if</span> i <span class="org-keyword">in</span> bd.known <span class="org-keyword">else</span> <span class="org-string">'.'</span>)
               <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n**2)]
  
      <span class="org-variable-name">width</span> = <span class="org-builtin">max</span>(<span class="org-builtin">map</span>(<span class="org-builtin">len</span>, svals))
      <span class="org-variable-name">fmt</span> = <span class="org-keyword">lambda</span> cell: (<span class="org-string">'%%%ds'</span> % width) % cell
  
      <span class="org-variable-name">n_x_n</span> = [svals[i*n : i*n + n] <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n)]
      <span class="org-variable-name">cols_grpd</span> = [<span class="org-string">' | '</span>.join(<span class="org-string">' '</span>.join(<span class="org-builtin">map</span>(fmt, row[j*order : j*order + order]))
                             <span class="org-keyword">for</span> j <span class="org-keyword">in</span> <span class="org-builtin">range</span>(order))
                   <span class="org-keyword">for</span> row <span class="org-keyword">in</span> n_x_n]    
      <span class="org-variable-name">rows_grpd</span> = [<span class="org-string">'\n'</span>.join(cols_grpd[i*order : i*order + order])
                   <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(order)]
  
      <span class="org-variable-name">rule</span> = <span class="org-string">'\n'</span> + <span class="org-string">''</span>.join(<span class="org-string">'+'</span> <span class="org-keyword">if</span> c == <span class="org-string">'|'</span> <span class="org-keyword">else</span> <span class="org-string">'-'</span> <span class="org-keyword">for</span> c <span class="org-keyword">in</span> cols_grpd[0]) + <span class="org-string">'\n'</span>
  
      <span class="org-keyword">return</span> rule.join(rows_grpd)</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbfa0b4b" class="outline-2">
<h2 id="orgbfa0b4b"><span class="section-number-2">3</span> Solving Sudoku</h2>
<div class="outline-text-2" id="text-3">
<p>
Having a suitable representation of the board state, we can now work out how to
solve a Sudoku puzzle. All of the techniques discussed here rely on the
constraint propagation that <a href="#org3521edc"><code>board.mark</code></a> performs automatically.
</p>
</div>

<div id="outline-container-org503cb5c" class="outline-3">
<h3 id="org503cb5c"><span class="section-number-3">3.1</span> Deductive Techniques</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Consider how a human might approach a grid like
</p>


<div class="figure">
<p><img src="images/ex-1-1.png" alt="ex-1-1.png" />
</p>
</div>

<p>
Let&rsquo;s immediately reject the idea of blindly trying numbers until something
works. Instead, let&rsquo;s annotate the board with the remaining possibilities
(called <i>pencil marks</i>) for each unknown cell, revealing our true situation:
</p>


<div class="figure">
<p><img src="images/ex-1-2.png" alt="ex-1-2.png" />
</p>
</div>
</div>
<div id="outline-container-org119a49a" class="outline-4">
<h4 id="org119a49a"><span class="section-number-4">3.1.1</span> Single Candidate/Naked Single</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
The cell indicated with a red box can only take on a value of 2; if we mark
it as such, then we have to remove 2 from the possibilities for the
remaining cells that share a row, column, or box (the cells to be modified
are indicated with red digits).
</p>

<p>
The process can be expressed as
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1e802dd"><div id='functions-14163'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-12400'>&uarr;</a><a href='#functions-14929'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">mark_single_vals</span>(bd):
      <span class="org-doc">'applies the "single candidate" (a.k.a. "naked single") rule'</span>
      <span class="org-variable-name">marked</span> = <span class="org-constant">False</span>
      <span class="org-keyword">for</span> (cell, vals) <span class="org-keyword">in</span> <span class="org-builtin">list</span>(bd.unknown.items()):
          <span class="org-keyword">if</span> <span class="org-builtin">len</span>(vals) == 1:
              bd.mark(cell, <span class="org-builtin">set</span>(vals).pop())
              <span class="org-variable-name">marked</span> = <span class="org-constant">True</span>
  
      <span class="org-keyword">return</span> marked</pre>
</div>

<p>
Marking the cell with a 2 gives us
</p>


<div class="figure">
<p><img src="images/ex-1-4.png" alt="ex-1-4.png" />
</p>
</div>

<p>
Continuing on in this way eventually yields
</p>


<div class="figure">
<p><img src="images/ex-1-5.png" alt="ex-1-5.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgb287a01" class="outline-4">
<h4 id="orgb287a01"><span class="section-number-4">3.1.2</span> Single Placement/Hidden Single</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
While none of the unknown cells has only one possible value, there are two cells
that each can only hold a 5. Marking and eliminating, we have
</p>


<div class="figure">
<p><img src="images/ex-1-6.png" alt="ex-1-6.png" />
</p>
</div>

<p>
We can express the technique like so:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org0a56244"><div id='functions-14929'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-14163'>&uarr;</a><a href='#functions-15341'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">mark_single_cells</span>(bd):
      <span class="org-doc">'applies the "hidden single" rule'</span>
      <span class="org-variable-name">marked</span> = <span class="org-constant">False</span>
      <span class="org-variable-name">hidden</span> = ((val, cells.pop())
                <span class="org-keyword">for</span> div <span class="org-keyword">in</span> bd.div2cells
                <span class="org-keyword">for</span> (val, cells) <span class="org-keyword">in</span> placements(bd, div).items()
                <span class="org-keyword">if</span> <span class="org-builtin">len</span>(cells) == 1)
      <span class="org-keyword">for</span> (val, cell) <span class="org-keyword">in</span> hidden:
          <span class="org-keyword">if</span> val <span class="org-keyword">in</span> bd.unknown.get(cell, <span class="org-builtin">set</span>()):
              bd.mark(cell, val)
              <span class="org-variable-name">marked</span> = <span class="org-constant">True</span>
      <span class="org-keyword">return</span> marked</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="org565092a"><div id='functions-15341'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-14929'>&uarr;</a><a href='#functions-15721'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">placements</span>(bd, div):
      <span class="org-keyword">return</span> transpose({cell: bd.unknown[cell]
                        <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> bd.div2cells[div]
                        <span class="org-keyword">if</span> cell <span class="org-keyword">in</span> bd.unknown})</pre>
</div>
</div>
</div>

<div id="outline-container-org2c24436" class="outline-4">
<h4 id="org2c24436"><span class="section-number-4">3.1.3</span> Rule of Exclusion</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Whenever a value in a division is constrained to two or more cells, we can
eliminate that value from any additional neighbors that those cells
share:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org82918e8"><div id='functions-15721'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-15341'>&uarr;</a><a href='#functions-16301'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">mark_excluded</span>(bd):
      <span class="org-variable-name">marked</span> = <span class="org-constant">False</span>
      <span class="org-variable-name">excluded</span> = ((cell, val)
                  <span class="org-keyword">for</span> div0 <span class="org-keyword">in</span> bd.div2cells
                  <span class="org-keyword">for</span> (val, cells) <span class="org-keyword">in</span> placements(bd, div0).items()
                  <span class="org-keyword">for</span> div <span class="org-keyword">in</span> (intersection(bd.cell2divs[cell] <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> cells)
                              - {div0})
                  <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> bd.div2cells[div] - cells - <span class="org-builtin">set</span>(bd.known)
                  <span class="org-keyword">if</span> val <span class="org-keyword">in</span> bd.unknown[cell])
      <span class="org-keyword">for</span> (cell, val) <span class="org-keyword">in</span> excluded:
          bd.elim(cell, val)
          <span class="org-variable-name">marked</span> = <span class="org-constant">True</span>
      <span class="org-keyword">return</span> marked</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgead85a9"><div id='imports-16211'>&langle;<a href='#imports' class='noweb-ref'>imports</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#imports-8275'>&uarr;</a><a href='#imports-20722'>&darr;</a></span></div>  <span class="org-keyword">from</span> functools <span class="org-keyword">import</span> <span class="org-builtin">reduce</span></pre>
</div>
<div class="org-src-container">
<pre class="src src-python" id="orgcae605c"><div id='functions-16301'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-15721'>&uarr;</a><a href='#functions-16540'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">intersection</span>(xs): <span class="org-keyword">return</span> <span class="org-builtin">reduce</span>(<span class="org-keyword">lambda</span> a,x: a&amp;x, xs)</pre>
</div>
</div>
</div>

<div id="outline-container-org3c12187" class="outline-4">
<h4 id="org3c12187"><span class="section-number-4">3.1.4</span> Combining Strategies</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
We can continue applying these techniques, favoring the simplest whenever
possible,
</p>

<div class="org-src-container">
<pre class="src src-python" id="org6a1311e"><div id='functions-16540'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-16301'>&uarr;</a><a href='#functions-19222'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">mark_forced</span>(bd):
      <span class="org-doc">'''</span>
  <span class="org-doc">    iteratively applies single candidate, hidden single, and rule of exclusion</span>
  <span class="org-doc">    until no further modifications are possible</span>
  <span class="org-doc">    '''</span>
      <span class="org-variable-name">fns</span> = (mark_single_vals, mark_single_cells, mark_excluded)
      <span class="org-keyword">while</span> <span class="org-builtin">any</span>(fn(bd) <span class="org-keyword">for</span> fn <span class="org-keyword">in</span> fns): <span class="org-keyword">pass</span>
      <span class="org-keyword">return</span> bd</pre>
</div>

<p>
until we reach
</p>


<div class="figure">
<p><img src="images/ex-1-7.png" alt="ex-1-7.png" />
</p>
</div>

<p>
which will not yield to any of them. At this point, we have a couple
options:
</p>

<ul class="org-ul">
<li>We can crack open any number of guides on Sudoku to find other strategies that
might apply, or,</li>
<li>We can guess at the next play.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2d0cee5" class="outline-3">
<h3 id="org2d0cee5"><span class="section-number-3">3.2</span> Searching</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Rather than further accumulating strategies until we build up a corpus of
Sudoku-solving lore, let&rsquo;s do what any player out of options would do: Let&rsquo;s
guess. Once we&rsquo;ve made our guess, we&rsquo;ll play it out, using our deductive
rules as we can, and guessing again as necessary. If it becomes clear that
our guess is wrong, we&rsquo;ll come back to this board state and try something
else. In short, we&rsquo;ll perform a depth-first search through the space of
Sudoku boards.
</p>

<p>
Let&rsquo;s consider what happens if we choose poorly:
</p>

<ul class="org-ul">
<li>We&rsquo;ll find ourselves back at our current board state, choosing a different
cell/value assignment to try; and,</li>
<li>We&rsquo;ll have eliminated the cell/value combination we just tried as being valid
for <i>any board state derived from our current state</i>.</li>
</ul>

<p>
So, if an incorrect guess allows us to <i>prune</i> part of the search space, we
should structure our guessing so that each incorrect choice prunes as large a
subtree as possible, allowing us to more quickly focus on the correct
subtree. An easy and effective approach is to find the cell with the fewest
possible values and then try each of them until we&rsquo;re successful. So,
choosing the red-boxed cell in
</p>


<div class="figure">
<p><img src="images/ex-1-8.png" alt="ex-1-8.png" />
</p>
</div>

<p>
we can choose either a 2 or a 6. If the solution is ultimately derived from our
current board state, then one of these values must be correct, giving a 50%
chance of guessing correctly the first time. Should we exhaust both numbers
without finding a solution, then there is no solution to be had from our current
state&#x2013;either the game is unsolvable or we previously made a mistake. A first
draft might look like
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">solve</span>(bd):
    <span class="org-keyword">def</span> <span class="org-function-name">_solve</span>(bd):
        mark_forced(bd)
        <span class="org-keyword">if</span> issolved(bd): <span class="org-keyword">yield</span> bd
        <span class="org-keyword">else</span>:
            <span class="org-variable-name">_</span>, <span class="org-variable-name">cell</span>, <span class="org-variable-name">vals</span> = <span class="org-builtin">min</span>((<span class="org-builtin">len</span>(vals), cell, vals)
                                <span class="org-keyword">for</span> (cell, vals) <span class="org-keyword">in</span> bd.unknwon.items())
            <span class="org-keyword">for</span> val <span class="org-keyword">in</span> vals:
                <span class="org-keyword">yield</span> <span class="org-keyword">from</span> _solve(bd.marked(cell, val))
    <span class="org-keyword">return</span> solve(bd.copy())</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="org41c3c9e"><div id='functions-19222'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-16540'>&uarr;</a><a href='#functions-21845'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">issolved</span>(bd):
      <span class="org-doc">'return True when no unknown cells remain. Assumes the board is valid.'</span>
      <span class="org-keyword">return</span> <span class="org-keyword">not</span> bd.unknown</pre>
</div>

<p>
Because <code>mark_forced</code> results in modifications to the board passed in, rather
than a new board suitably modified, <code>solve</code> begins by making a copy of the
board to be solved; this gives us a pure functional interface.
</p>

<p>
Besides solving Sudoku puzzles, <code>solve</code> actually plays two key roles in the
puzzle generation procedure. The first of those is generating the solved
board. Once a cell is selected, there is no decisive advantage to preferring
one ordering of the possible values over another. Likewise, if there are two
or more cells meeting our minimum-values criterion, there is little reason to
prefer one over another. By randomizing both cell selection and value
ordering, we can retrieve all solutions of a given board in random
order. This allows us to pass <code>solve</code> a blank board, and the first solution
generated will be a randomly-selected Sudoku solution:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">solve</span>(bd):
    <span class="org-keyword">def</span> <span class="org-function-name">_solve</span>(bd):
        mark_forced(bd)
        <span class="org-keyword">if</span> issolved(bd): <span class="org-keyword">yield</span> bd
        <span class="org-keyword">else</span>:
            <span class="org-variable-name">_</span>, <span class="org-variable-name">_</span>, <span class="org-variable-name">cell</span>, <span class="org-variable-name">vals</span> = <span class="org-builtin">min</span>((<span class="org-builtin">len</span>(vals), random.random(), cell, vals)
                                   <span class="org-keyword">for</span> (cell, vals) <span class="org-keyword">in</span> bd.unknwon.items())
            <span class="org-keyword">for</span> val <span class="org-keyword">in</span> random.sample(vals, <span class="org-builtin">len</span>(vals)):
                <span class="org-keyword">yield</span> <span class="org-keyword">from</span> _solve(bd.marked(cell, val))
    <span class="org-keyword">return</span> solve(bd.copy())</pre>
</div>

<p>
for which we&rsquo;d need
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgcf82fa8"><div id='imports-20722'>&langle;<a href='#imports' class='noweb-ref'>imports</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#imports-16211'>&uarr;</a><a href='#imports-21416'>&darr;</a></span></div>  <span class="org-keyword">import</span> random</pre>
</div>

<p>
For reasons of both performance and controlling difficulty, we might need to
limit the number of guesses needed to solve a given board.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">solve</span>(bd, maxguesses=inf):
    <span class="org-keyword">def</span> <span class="org-function-name">_solve</span>(bd, depth=0):
        mark_forced(bd)    
        <span class="org-keyword">if</span> issolved(bd):
            <span class="org-keyword">yield</span> bd 
        <span class="org-keyword">elif</span> depth &lt; maxguesses:
            <span class="org-variable-name">_</span>, <span class="org-variable-name">_</span>, <span class="org-variable-name">cell</span>, <span class="org-variable-name">vals</span> = <span class="org-builtin">min</span>((<span class="org-builtin">len</span>(vals), random.random(), cell, vals)
                                   <span class="org-keyword">for</span> (cell, vals) <span class="org-keyword">in</span> bd.unknown.items())
            <span class="org-keyword">for</span> val <span class="org-keyword">in</span> random.sample(vals, <span class="org-builtin">len</span>(vals)):
                <span class="org-keyword">yield</span> <span class="org-keyword">from</span> _solve(bd.marked(cell, val), depth=depth+1)

    <span class="org-keyword">return</span> _solve(bd.copy())</pre>
</div>

<p>
which requires
</p>

<div class="org-src-container">
<pre class="src src-python" id="org097df8b"><div id='imports-21416'>&langle;<a href='#imports' class='noweb-ref'>imports</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#imports-20722'>&uarr;</a></span></div>  <span class="org-keyword">from</span> math <span class="org-keyword">import</span> inf</pre>
</div>

<p>
However, Python has a default maximum recursion depth of 1000 calls; when
generating solutions for boards requiring large numbers of guesses (e.g.,
when filling in blank boards of order 6 or larger), generating a
<code>RecursionError</code> is a very real possibility. This concern leads us to the
iterative implementation that we actually use.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf69eebe"><div id='functions-21845'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-19222'>&uarr;</a><a href='#functions-23990'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">solve</span>(bd0, maxguesses=inf):
      <span class="org-doc">'given a board bd0, generate all solutions in maxguesses guesses'</span>
      <span class="org-variable-name">stack</span> = [(0, bd0.copy(), <span class="org-constant">None</span>)]
      <span class="org-keyword">while</span> stack:
          <span class="org-variable-name">depth</span>, <span class="org-variable-name">bd</span>, <span class="org-variable-name">delta</span> = stack.pop()
          <span class="org-keyword">if</span> delta: <span class="org-variable-name">bd</span> = bd.marked(*delta)
          mark_forced(bd)
          <span class="org-keyword">if</span> issolved(bd): <span class="org-keyword">yield</span> bd
          <span class="org-keyword">elif</span> depth &lt; maxguesses:
              <span class="org-variable-name">_</span>, <span class="org-variable-name">_</span>, <span class="org-variable-name">cell</span>, <span class="org-variable-name">vals</span> = <span class="org-builtin">min</span>((<span class="org-builtin">len</span>(vals), random.random(), cell, vals)
                                     <span class="org-keyword">for</span> (cell, vals) <span class="org-keyword">in</span> bd.unknown.items())
              stack.extend((depth+1, bd, (cell, val))
                           <span class="org-keyword">for</span> val <span class="org-keyword">in</span> random.sample(vals, <span class="org-builtin">len</span>(vals)))</pre>
</div>

<p>
Delaying production of each intermediate board until it&rsquo;s required saves us
significant amounts of memory when solving large boards.
</p>

<p>
Now, we can generate the final solution to our original puzzle:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-builtin">next</span>(solve(load_board(<span class="org-string">'''</span>
<span class="org-string">8 3 . | . . . | . . 4</span>
<span class="org-string">9 . . | . . . | . 6 .</span>
<span class="org-string">. 1 . | 4 5 . | . 7 .</span>
<span class="org-string">------+-------+------</span>
<span class="org-string">. . . | . . 5 | . . 3</span>
<span class="org-string">. . 5 | . 1 8 | . . .</span>
<span class="org-string">. . . | . . 3 | 4 9 .</span>
<span class="org-string">------+-------+------</span>
<span class="org-string">. . . | . 6 . | 7 . .</span>
<span class="org-string">. . . | . . 1 | . . .</span>
<span class="org-string">. . . | 8 . . | . . 1</span>
<span class="org-string">'''</span>)))</pre>
</div>

<p>
yields
</p>


<div class="figure">
<p><img src="images/ex-1-soln.png" alt="ex-1-soln.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbfb7914" class="outline-2">
<h2 id="orgbfb7914"><span class="section-number-2">4</span> Generating Sudoku</h2>
<div class="outline-text-2" id="text-4">
<p>
To generate a puzzle, we&rsquo;ll work backwards from the solution, iteratively
testing each cell to determine whether the board remains <i>proper</i>&#x2014;i.e., has
exactly one solutions&#x2014;if the cell is made an unknown. Those that can be
masked out (i.e., rendered unknown) are; those that can&rsquo;t become the clues. A
naive first version would look something like
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">generate_from</span>(soln):
    <span class="org-variable-name">known</span> = soln.known.copy()
    <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>(<span class="org-builtin">len</span>(known) ** 0.25)
    <span class="org-variable-name">clues</span> = {}
    <span class="org-variable-name">new</span> = <span class="org-keyword">lambda</span>: marked_up(order, *known.items(), *clues.items())

    <span class="org-keyword">while</span> known:
        <span class="org-variable-name">cell</span> = random.choice(<span class="org-builtin">list</span>(known))
        <span class="org-variable-name">val</span> = known.pop(cell)
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> isproper(new()):
            <span class="org-variable-name">clues</span>[cell] = val

    <span class="org-keyword">return</span> new()</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">isproper</span>(bd):
    <span class="org-variable-name">nsolns</span> = 0
    <span class="org-keyword">for</span> soln <span class="org-keyword">in</span> solve(bd):
        <span class="org-variable-name">nsolns</span> += 1
        <span class="org-keyword">if</span> nsolns &gt; 1: <span class="org-keyword">break</span>

    <span class="org-keyword">return</span> nsolns == 1</pre>
</div>

<p>
and
</p>

<div class="org-src-container">
<pre class="src src-python" id="org04a2081"><div id='functions-23990'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-21845'>&uarr;</a><a href='#functions-25470'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">marked_up</span>(order, *marks):
      <span class="org-doc">'''</span>
  <span class="org-doc">    returns a new board of the given order, with the given marks, (cell, val)</span>
  <span class="org-doc">    pairs, applied</span>
  <span class="org-doc">    '''</span>
      <span class="org-variable-name">bd</span> = blank(order)
      <span class="org-keyword">for</span> mark <span class="org-keyword">in</span> marks: bd.mark(*mark)
      <span class="org-keyword">return</span> bd</pre>
</div>

<p>
However, the naive procedure&rsquo;s performance degrades rapidly with increasing
order&#x2014;checking a board&rsquo;s propriety requires solving it, and <code>solve</code>&rsquo;s
complexity grows exponentially with the number of unknown cells. A few
measures can salvage this situation:
</p>

<ul class="org-ul">
<li>We can safely mask out any cell that can be deduced based on the currently
known cells.</li>
<li>Checking whether masking out a given cell would result in proper board
requires attempting to solve the board resulting from masking the cell. We
can constrain the solver to only generate solutions within a certain number
of guesses. Doing so allows a faster, though weaker, check for propriety. It
also provides us a means of limiting the end result&rsquo;s difficulty.</li>
<li>The solver chooses from the unknown cells with the fewest possible values,
i.e., it attempts to minimize the branching factor. We can limit unknown
cells only to those that the solver would choose among.</li>
</ul>

<p>
We can estimate difficulty by multiplying the number of possibilities for each
cell we mask; this represents the total number of choices that a perfect
player would face. 
</p>

<p>
The generation procedure we&rsquo;ll actually use is
</p>

<div class="org-src-container">
<pre class="src src-python" id="org22382a3"><div id='functions-25470'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-23990'>&uarr;</a><a href='#functions-27032'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">generate_from</span>(soln, minbranch=<span class="org-constant">False</span>, maxguesses=inf):
      <span class="org-doc">'''</span>
  <span class="org-doc">    Generate a board for which soln is a solution, within at most maxguesses</span>
  <span class="org-doc">    guesses. If set, minbranch restricts unknown cells to those that</span>
  
  <span class="org-doc">    - can be easily deduced or</span>
  <span class="org-doc">    - are among those with the fewest possible values.</span>
  
  <span class="org-doc">    If maxguesses &lt; inf, the generated board is guaranteed to be solvable</span>
  <span class="org-doc">    within the prescribed number of guesses, but is not guaranteed to have only</span>
  <span class="org-doc">    one solution.</span>
  
  <span class="org-doc">    Returns (bd, difficulty) where bd is the generated board and difficulty is </span>
  <span class="org-doc">    a difficulty estimate.</span>
  <span class="org-doc">    '''</span>
      <span class="org-variable-name">known</span> = soln.known.copy()
      <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>(<span class="org-builtin">len</span>(known) ** 0.25)
      <span class="org-variable-name">clues</span> = {}
      <span class="org-variable-name">new</span> = <span class="org-keyword">lambda</span>: marked_up(order, *known.items(), *clues.items())    
      <span class="org-variable-name">minunks</span> = <span class="org-keyword">lambda</span> bd: <span class="org-builtin">min</span>(<span class="org-builtin">map</span>(<span class="org-builtin">len</span>, bd.unknown.values()))
      <span class="org-variable-name">guesses</span> = 0
      <span class="org-variable-name">difficulty</span> = 1
  
      <span class="org-keyword">while</span> known:
          <span class="org-variable-name">cell</span> = random.choice(<span class="org-builtin">list</span>(known))
          <span class="org-variable-name">val</span> = known.pop(cell)
          <span class="org-variable-name">bd2</span> = new()
          mark_forced(bd2)
  
          <span class="org-keyword">if</span> cell <span class="org-keyword">in</span> bd2.known: <span class="org-keyword">pass</span>
          <span class="org-keyword">elif</span> (guesses &gt;= maxguesses
                <span class="org-keyword">or</span> minbranch <span class="org-keyword">and</span> <span class="org-builtin">len</span>(bd2.unknown[cell]) &gt; minunks(bd2)
                <span class="org-keyword">or</span> <span class="org-keyword">not</span> isproper(bd2, maxguesses=maxguesses, clue=(cell, val))):
              <span class="org-variable-name">clues</span>[cell] = val
          <span class="org-keyword">else</span>:
              <span class="org-variable-name">difficulty</span> *= <span class="org-builtin">len</span>(bd2.unknown[cell])
              <span class="org-variable-name">guesses</span> += 1
  
      <span class="org-keyword">return</span> new(), difficulty</pre>
</div>

<p>
We know that marking the masked cell with the value it previously had will
ultimately result in a solution; exploiting that knowledge when testing a
board derived from a board known to be proper,
</p>

<div class="org-src-container">
<pre class="src src-python" id="org7eaba79"><div id='functions-27032'>&langle;<a href='#functions' class='noweb-ref'>functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#functions-25470'>&uarr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">isproper</span>(bd, maxguesses=inf, clue=<span class="org-constant">None</span>):
      <span class="org-doc">'bd has exactly one solution within maxguesses guesses'</span>
      <span class="org-variable-name">nsolns</span> = 0
      <span class="org-keyword">if</span> clue:
          <span class="org-variable-name">cell0</span>, <span class="org-variable-name">val0</span> = clue
          <span class="org-variable-name">nsolns</span> += 1
          <span class="org-keyword">for</span> val <span class="org-keyword">in</span> bd.unknown[cell0] - {val0}:
              <span class="org-keyword">for</span> soln <span class="org-keyword">in</span> solve(bd.marked(cell0, val), maxguesses):
                  <span class="org-variable-name">nsolns</span> += 1
                  <span class="org-keyword">if</span> nsolns &gt; 1: <span class="org-keyword">return</span> <span class="org-constant">False</span>
      <span class="org-keyword">else</span>:
          <span class="org-keyword">for</span> soln <span class="org-keyword">in</span> solve(bd, maxguesses):
              <span class="org-variable-name">nsolns</span> += 1
              <span class="org-keyword">if</span> nsolns &gt; 1: <span class="org-keyword">return</span> <span class="org-constant">False</span>
  
      <span class="org-keyword">return</span> nsolns == 1</pre>
</div>

<p>
We can now create puzzles of various sizes; for example, order 2:
</p>


<div class="figure">
<p><img src="images/order2.png" alt="order2.png" />
</p>
</div>

<p>
order 3:
</p>


<div class="figure">
<p><img src="images/order3.png" alt="order3.png" />
</p>
</div>

<p>
and order 4:
</p>

<div class="figure">
<p><img src="images/order4.png" alt="order4.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org1514f2b" class="outline-2">
<h2 id="org1514f2b"><span class="section-number-2">5</span> Utility Library</h2>
<div class="outline-text-2" id="text-5">
<p>
Before going any further, let&rsquo;s package what we have so far into a library:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org361ec1b"><div id='sudoku/__init__.py'>&langle;<span class='noweb-def' id='sudoku/__init__.py-27867'>sudoku/__init__.py</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-doc">'useful utilities for manipulating Sudoku puzzles'</span>
  
  &langle;<a class='noweb-ref' href='#imports'>imports</a>&rangle;
  &langle;<a class='noweb-ref' href='#data types'>data types</a>&rangle;
  &langle;<a class='noweb-ref' href='#functions'>functions</a>&rangle;</pre>
</div>

<p>
The finished product is <a href="./sudoku/__init__.py">./sudoku/__init__.py</a>.
</p>
</div>
</div>
<div id="outline-container-orgf92393f" class="outline-2">
<h2 id="orgf92393f"><span class="section-number-2">6</span> Command Line Tools</h2>
<div class="outline-text-2" id="text-6">
<p>
Having a library encapsulating the bulk of what we might wish to do, let&rsquo;s
make it more operationally useful by creating a series of tools that we can
use from a command line or shell script. 
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga54822e"><div id='common'>&langle;<span class='noweb-def' id='common-28304'>common</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">import</span> sys
  
  <span class="org-keyword">def</span> <span class="org-function-name">usage</span>():
      <span class="org-keyword">return</span> <span class="org-builtin">__doc__</span>.lstrip() % sys.argv[0]
  
  <span class="org-keyword">if</span> <span class="org-builtin">__name__</span> == <span class="org-string">'__main__'</span>:
      <span class="org-keyword">if</span> <span class="org-builtin">set</span>(sys.argv) &amp; {<span class="org-string">'-h'</span>, <span class="org-string">'--help'</span>}:
          sys.<span class="org-constant">exit</span>(usage())
      <span class="org-keyword">else</span>:
          main(sys.argv[1:])</pre>
</div>
</div>

<div id="outline-container-orgfedb56d" class="outline-3">
<h3 id="orgfedb56d"><span class="section-number-3">6.1</span> The Solver</h3>
<div class="outline-text-3" id="text-6-1">
<p>
The solver should read a board, as defined by <code>load_board</code>, from either a
file or standard input, and emit all the solutions to standard output. The
overall program structure should look something like
</p>

<div class="org-src-container">
<pre class="src src-python" id="org283f2da"><div id='bin/sudoku'>&langle;<span class='noweb-def' id='bin/sudoku-28782'>bin/sudoku</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  &langle;<a class='noweb-ref' href='#solver usage'>solver usage</a>&rangle;
  &langle;<a class='noweb-ref' href='#solver imports'>solver imports</a>&rangle;
  &langle;<a class='noweb-ref' href='#solver functions'>solver functions</a>&rangle;
  &langle;<a class='noweb-ref' href='#common'>common</a>&rangle;</pre>
</div>

<p>
where 
</p>

<div class="org-src-container">
<pre class="src src-python" id="org63c05f3"><div id='solver usage'>&langle;<span class='noweb-def' id='solver usage-28931'>solver usage</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-doc">'''</span>
  <span class="org-doc">Usage: %s [FILE]</span>
  <span class="org-doc">Find all solutions for a Sudoku puzzle.</span>
  
  <span class="org-doc">Options:</span>
  <span class="org-doc">  -h, --help    print this help and exit</span>
  
  <span class="org-doc">If FILE is omitted or `-', then the initial board is read from stdin.</span>
  
  <span class="org-doc">The input board should consist of a series of cells, each either a positive </span>
  <span class="org-doc">integer or a `.' to denote an unknown value, separated by any characters not in </span>
  <span class="org-doc">/[0-9.]/. The order of the board is automatically detected as the fourth root of </span>
  <span class="org-doc">the number of cells, and it must be an integer. The numerical values are </span>
  <span class="org-doc">constrained from 1 to order**2 inclusive.</span>
  
  <span class="org-doc">The solutions will always be ``pretty-printed'', e.g.,</span>
  
  <span class="org-doc">  solution 1:</span>
  <span class="org-doc">  4 2 7 | 1 3 6 | 5 8 9</span>
  <span class="org-doc">  6 5 1 | 9 2 8 | 4 7 3</span>
  <span class="org-doc">  3 8 9 | 5 4 7 | 1 6 2</span>
  <span class="org-doc">  ------+-------+------</span>
  <span class="org-doc">  2 3 5 | 8 1 9 | 7 4 6</span>
  <span class="org-doc">  9 6 8 | 3 7 4 | 2 1 5</span>
  <span class="org-doc">  7 1 4 | 2 6 5 | 9 3 8</span>
  <span class="org-doc">  ------+-------+------</span>
  <span class="org-doc">  8 9 6 | 7 5 1 | 3 2 4</span>
  <span class="org-doc">  1 4 3 | 6 9 2 | 8 5 7</span>
  <span class="org-doc">  5 7 2 | 4 8 3 | 6 9 1</span>
  
  <span class="org-doc">  solution 2:</span>
  <span class="org-doc">  ...</span>
  
  <span class="org-doc">It is the case that a ``proper'' Sudoku can have only one solution; however, </span>
  <span class="org-doc">``improper'' Sudoku puzzles do exist.</span>
  <span class="org-doc">'''</span></pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgb9ade14"><div id='solver imports'>&langle;<span class='noweb-def' id='solver imports-30095'>solver imports</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">import</span> sys
  <span class="org-keyword">import</span> sudoku <span class="org-keyword">as</span> sd</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org45a358c"><div id='solver functions'>&langle;<span class='noweb-def' id='solver functions-30194'>solver functions</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">main</span>(argv):
      <span class="org-variable-name">fn</span> = argv[0] <span class="org-keyword">if</span> argv <span class="org-keyword">else</span> <span class="org-string">'-'</span>
      <span class="org-keyword">try</span>:
          <span class="org-variable-name">bd</span> = sd.load_board((sys.stdin <span class="org-keyword">if</span> fn == <span class="org-string">'-'</span> <span class="org-keyword">else</span> <span class="org-builtin">open</span>(fn)).read())
      <span class="org-keyword">except</span> <span class="org-type">ValueError</span>:
          sys.<span class="org-constant">exit</span>(<span class="org-string">'ill-formed board'</span>)
  
      <span class="org-keyword">for</span> (i, soln) <span class="org-keyword">in</span> <span class="org-builtin">enumerate</span>(sd.solve(bd), start=1):
          <span class="org-keyword">assert</span> sd.isvalid(soln) <span class="org-keyword">and</span> sd.issolved(soln)
          <span class="org-keyword">print</span>(<span class="org-string">'solution %s:'</span> % i)
          <span class="org-keyword">print</span>(sd.dump_board(soln))
          <span class="org-keyword">print</span>()</pre>
</div>

<p>
to give our <a href="bin/sudoku">finished Sudoku solver</a>.
</p>
</div>
</div>

<div id="outline-container-org936aac9" class="outline-3">
<h3 id="org936aac9"><span class="section-number-3">6.2</span> The Generator</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The overall structure for the generator is much like that of the solver:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org10a6e69"><div id='bin/sudokugen'>&langle;<span class='noweb-def' id='bin/sudokugen-30792'>bin/sudokugen</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  &langle;<a class='noweb-ref' href='#generator usage'>generator usage</a>&rangle;
  &langle;<a class='noweb-ref' href='#generator imports'>generator imports</a>&rangle;
  &langle;<a class='noweb-ref' href='#generator functions'>generator functions</a>&rangle;
  &langle;<a class='noweb-ref' href='#common'>common</a>&rangle;</pre>
</div>

<p>
where
</p>

<div class="org-src-container">
<pre class="src src-python" id="org4a2fa27"><div id='generator usage'>&langle;<span class='noweb-def' id='generator usage-30952'>generator usage</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-doc">'''</span>
  <span class="org-doc">Usage: %s [-o ORDER] [-g MAXGUESSES] [-m]</span>
  <span class="org-doc">Generate a Sudoku puzzle.</span>
  
  <span class="org-doc">Options:</span>
  <span class="org-doc">  -h, --help    print this help and exit</span>
  
  <span class="org-doc">  -g MAXGUESSES</span>
  <span class="org-doc">                when testing potential clues, restrict solver to a depth of </span>
  <span class="org-doc">                MAXGUESSES</span>
  
  <span class="org-doc">  -m            only remove cells that can be deduced or have that might be</span>
  <span class="org-doc">                among the best candidates</span>
  
  <span class="org-doc">If the computed puzzle is not proper (i.e., has exactly one solution), exits </span>
  <span class="org-doc">with nonzero status.</span>
  <span class="org-doc">'''</span></pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org2a7d442"><div id='generator imports'>&langle;<span class='noweb-def' id='generator imports-31479'>generator imports</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">import</span> getopt
  <span class="org-keyword">from</span> math <span class="org-keyword">import</span> inf
  <span class="org-keyword">import</span> sudoku <span class="org-keyword">as</span> sd</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgc0fce55"><div id='generator functions'>&langle;<span class='noweb-def' id='generator functions-31608'>generator functions</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">main</span>(argv):
      <span class="org-variable-name">opts_</span>, <span class="org-variable-name">args</span> = getopt.gnu_getopt(argv, <span class="org-string">'g:mo:'</span>)
      <span class="org-variable-name">opts</span> = <span class="org-builtin">dict</span>(opts_)
  
      <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>(opts.get(<span class="org-string">'-o'</span>, 3))
      <span class="org-variable-name">maxguesses</span> = <span class="org-builtin">int</span>(opts[<span class="org-string">'-g'</span>]) <span class="org-keyword">if</span> <span class="org-string">'-g'</span> <span class="org-keyword">in</span> opts <span class="org-keyword">else</span> inf
      <span class="org-variable-name">minbranch</span> = <span class="org-string">'-m'</span> <span class="org-keyword">in</span> opts
      <span class="org-variable-name">soln</span> = <span class="org-builtin">next</span>(sd.solve(sd.blank(order)))
      <span class="org-variable-name">bd</span>, <span class="org-variable-name">difficulty</span> = sd.generate_from(soln,
                                        minbranch=minbranch,
                                        maxguesses=maxguesses)
      <span class="org-variable-name">proper</span> = sd.isproper(bd)
  
      <span class="org-keyword">print</span>(<span class="org-string">'difficulty:'</span>, difficulty)
      <span class="org-keyword">print</span>(<span class="org-string">'proper:'</span>, proper)
      <span class="org-keyword">print</span>()
      <span class="org-keyword">print</span>(sd.dump_board(bd))
      <span class="org-keyword">print</span>()
      <span class="org-keyword">print</span>(<span class="org-string">'&gt; '</span> + sd.dump_board(soln).replace(<span class="org-string">'\n'</span>, <span class="org-string">'\n&gt; '</span>))
  
      <span class="org-keyword">if</span> <span class="org-keyword">not</span> proper: <span class="org-constant">exit</span>(1)</pre>
</div>
</div>
</div>
<div id="outline-container-org7bc017a" class="outline-3">
<h3 id="org7bc017a"><span class="section-number-3">6.3</span> The Formatter</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Having the means to both generate and solve Sudoku puzzles, the next thing is
to nicely present them. We&rsquo;ll generate Latex source code as an intermediate
form, leaning on a custom Latex package for setting boards. Finally, we tie
things together with a convenience script that orchestrates conversion from
readable boards to transparent PNGs, like the figures in this article. What
follows depends on Latex and ImageMagick.
</p>
</div>

<div id="outline-container-orgbe47025" class="outline-4">
<h4 id="orgbe47025"><span class="section-number-4">6.3.1</span> Conversion to Latex</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
The overal structure of the Latex converter is
</p>

<div class="org-src-container">
<pre class="src src-python" id="org72e1bc7"><div id='bin/sudoku2tex'>&langle;<span class='noweb-def' id='bin/sudoku2tex-32852'>bin/sudoku2tex</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  &langle;<a class='noweb-ref' href='#formatter usage'>formatter usage</a>&rangle;
  &langle;<a class='noweb-ref' href='#formatter imports'>formatter imports</a>&rangle;
  &langle;<a class='noweb-ref' href='#formatter functions'>formatter functions</a>&rangle;
  &langle;<a class='noweb-ref' href='#common'>common</a>&rangle;</pre>
</div>

<p>
where the usage statement is
</p>

<div class="org-src-container">
<pre class="src src-python" id="org079d74d"><div id='formatter usage'>&langle;<span class='noweb-def' id='formatter usage-33044'>formatter usage</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-doc">'''</span>
  <span class="org-doc">Usage: %s [OPTIONS] [HIGHLIGHT]...</span>
  <span class="org-doc">Given a Sudoku board, generate Latex source code.</span>
  
  <span class="org-doc">Options:</span>
  <span class="org-doc">                x</span>
  <span class="org-doc">  -h, --help    print this help and exit</span>
  
  <span class="org-doc">  -p            print pencil marks for all unknown cells</span>
  
  <span class="org-doc">Cells are numbered sequentially from 0 in row-major order. Each HIGHLIGHT </span>
  <span class="org-doc">indicates a cell whose value (or pencil marks) will have its value surrounded</span>
  <span class="org-doc">by a red box; HIGHLIGHTs and any cell sharing a possible value with a HIGHLIGHT</span>
  <span class="org-doc">will have their possibilities set in red. In the absence of the -p option, only</span>
  <span class="org-doc">cells sharing a division with a HIGHLIGHT will be pencil marked.</span>
  
  <span class="org-doc">Used separately, the code generated by this program requires the sudokuii Latex </span>
  <span class="org-doc">package, included in the source repository (as latex/sudokuii.sty).</span>
  <span class="org-doc">'''</span></pre>
</div>

<p>
The Latex environment we&rsquo;ll use expects as input something like
</p>

<div class="org-src-container">
<pre class="src src-latex"><span class="org-keyword">\begin</span>{<span class="org-function-name">sudoku</span>}[2]
  |1|2|3|4|.
  |1|2|3|4|.
  |1|2|3|4|.
  |1|2|3|4|.
<span class="org-keyword">\end</span>{<span class="org-function-name">sudoku</span>}</pre>
</div>

<p>
The individual cells can contain more complex items than numbers, provided
they&rsquo;re suitably wrapped. Generating the <code>sudoku</code> environment falls to
</p>

<div class="org-src-container">
<pre class="src src-python" id="org61d9ba7"><div id='formatter functions'>&langle;<span class='noweb-def' id='formatter functions-34273'>formatter functions</span>&rangle; &equiv; <span class='chunk-chain'><a href='#formatter functions-35796'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">sudoku_env</span>(bd, pencil_marks, special):
      <span class="org-variable-name">ncells</span> = <span class="org-builtin">len</span>(bd.known) + <span class="org-builtin">len</span>(bd.unknown)
      <span class="org-variable-name">order</span> = <span class="org-builtin">int</span>(ncells**0.25)
      <span class="org-variable-name">n</span> = order**2
      <span class="org-variable-name">cells</span> = [<span class="org-builtin">str</span>(bd.known.get(i, <span class="org-string">' '</span>)) <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ncells)]
  
      <span class="org-keyword">if</span> pencil_marks: apply_pencils(bd, cells, order)
  
      <span class="org-variable-name">reds</span> = <span class="org-builtin">set</span>()
      <span class="org-variable-name">redboxes</span> = <span class="org-builtin">set</span>()
  
      <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> special:
          <span class="org-variable-name">dr</span>, <span class="org-variable-name">drb</span> = highlight(cell, bd, cells, order)
          <span class="org-variable-name">reds</span> |= dr
          <span class="org-variable-name">redboxes</span> |= drb
  
      <span class="org-variable-name">cells_fmtd</span> = fmt_cells(cells, bd, reds, redboxes)
      <span class="org-variable-name">grid</span> = form_body(cells_fmtd, n)
      <span class="org-variable-name">sudokusize</span> = n/9 * (17 <span class="org-keyword">if</span> pencil_marks <span class="org-keyword">or</span> redboxes <span class="org-keyword">else</span> 12)
      <span class="org-variable-name">unitlength</span> = sudokusize / n
      <span class="org-variable-name">fboxsep</span> = {2: 2, 3: 7, 4: 9}.get(order, 9) / 4 / n
  
      <span class="org-keyword">return</span> f<span class="org-string">'''</span>
  <span class="org-string">    \\setlength\\sudokusize{{{sudokusize}cm}}</span>
  <span class="org-string">    \\setlength\\unitlength{{{1/n}\\sudokusize}}</span>
  <span class="org-string">    \\setlength\\fboxsep{{-{fboxsep}\\unitlength}}</span>
  <span class="org-string">    \\renewcommand\\sudokuformat[1]{{\\Huge\\sffamily#1}}</span>
  
  <span class="org-string">    \\begin{{sudoku}}[{order}]</span>
  <span class="org-string">    {grid}</span>
  <span class="org-string">    \\end{{sudoku}}</span>
  <span class="org-string">    '''</span>
  
  <span class="org-keyword">def</span> <span class="org-function-name">form_body</span>(cells, n):
      <span class="org-variable-name">rows</span> = [cells[i*n : (i + 1) * n] <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n)]
      <span class="org-variable-name">lines</span> = [<span class="org-string">'|%s|.'</span> % <span class="org-string">'|'</span>.join(row) <span class="org-keyword">for</span> row <span class="org-keyword">in</span> rows]
      <span class="org-keyword">return</span> <span class="org-string">'\n'</span>.join(lines)</pre>
</div>

<p>
The calculations for <code>sudokusize</code> and <code>fboxsep</code> are the product of considerable
trial and error to determine what would look decent/reasonable/not terrible over
a range of board sizes.
</p>

<p>
Pencil marks should be formed in a square array containing just the values of
interest and little else. In practice, we have to add some blank rows and
columns to give more favorable placement in the cells.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgeeaf9af"><div id='formatter functions-35796'>&langle;<a href='#formatter functions' class='noweb-ref'>formatter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#formatter functions-34273'>&uarr;</a><a href='#formatter functions-36527'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">pencils</span>(possible, order):
      <span class="org-variable-name">vals</span> = [<span class="org-builtin">str</span>(val) <span class="org-keyword">if</span> val <span class="org-keyword">in</span> possible <span class="org-keyword">else</span> <span class="org-string">'.'</span>
              <span class="org-keyword">for</span> val <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, 1 + order**2)]
      <span class="org-variable-name">coldesc</span> = <span class="org-string">'c'</span> + <span class="org-string">'c'</span> * order
      <span class="org-variable-name">grid</span> = <span class="org-string">' \\\\\n'</span>.join(<span class="org-string">' &amp; '</span>.join(<span class="org-builtin">map</span>(<span class="org-builtin">str</span>, [<span class="org-string">'\\ \\ '</span>]
                                           + vals[order*i : order*(i + 1)]))
                            <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(order))
  
      <span class="org-keyword">return</span> f<span class="org-string">'''</span>
  <span class="org-string">    \\resizebox{{\\unitlength}}{{.6\\unitlength}}{{</span>
  <span class="org-string">    \\begin{{tabular}}{{{coldesc}}}</span>
  <span class="org-string">    \\ \\\\</span>
  <span class="org-string">    {grid} \\\\</span>
  <span class="org-string">    \\ \\\\</span>
  <span class="org-string">    \\end{{tabular}}</span>
  <span class="org-string">    }}</span>
  <span class="org-string">    '''</span>
  
  <span class="org-keyword">def</span> <span class="org-function-name">apply_pencils</span>(bd, cells, order):
      <span class="org-keyword">for</span> (unk, vals) <span class="org-keyword">in</span> bd.unknown.items():
          <span class="org-variable-name">cells</span>[unk] = pencils(vals, order)</pre>
</div>

<p>
We wish to call out cells of interest, and we also want to indicate how
constraints might propagate:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org4ab234d"><div id='formatter functions-36527'>&langle;<a href='#formatter functions' class='noweb-ref'>formatter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#formatter functions-35796'>&uarr;</a><a href='#formatter functions-37084'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">highlight</span>(cell0, bd, cells, order):
      <span class="org-variable-name">reds</span> = <span class="org-builtin">set</span>()
      <span class="org-variable-name">redboxes</span> = {cell0}
  
      <span class="org-keyword">for</span> div <span class="org-keyword">in</span> bd.cell2divs[cell0]:
          <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> bd.div2cells[div] - <span class="org-builtin">set</span>(bd.known):
              <span class="org-variable-name">cells</span>[cell] = pencils(bd.unknown[cell], order)
              <span class="org-keyword">if</span> bd.unknown[cell0] &amp; bd.unknown[cell]:
                  reds.add(cell)
      <span class="org-keyword">return</span> reds, redboxes</pre>
</div>

<p>
Once the pencil marks and highlights have been computed, we can format each cell
to show pencil marks, highlighted cells, and the possible effects of constraint
propagation:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orga19cdac"><div id='formatter functions-37084'>&langle;<a href='#formatter functions' class='noweb-ref'>formatter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#formatter functions-36527'>&uarr;</a><a href='#formatter functions-37645'>&darr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">fmt_cells</span>(cells, bd, reds, redboxes):
      <span class="org-variable-name">red</span> = <span class="org-keyword">lambda</span> s: <span class="org-string">'{\\color{red}%s}'</span> % s
      <span class="org-variable-name">redboxed</span> = <span class="org-keyword">lambda</span> s: <span class="org-string">'{\\color{red}\\fbox{%s}}'</span> % s
      <span class="org-variable-name">black</span> = <span class="org-keyword">lambda</span> s: <span class="org-string">'{\\color{black}%s}'</span> % s
  
      <span class="org-keyword">return</span> [redboxed(cell) <span class="org-keyword">if</span> i <span class="org-keyword">in</span> redboxes
              <span class="org-keyword">else</span> red(cell) <span class="org-keyword">if</span> i <span class="org-keyword">in</span> reds
              <span class="org-keyword">else</span> black(cell)
              <span class="org-keyword">for</span> (i, cell) <span class="org-keyword">in</span> <span class="org-builtin">enumerate</span>(cells)]</pre>
</div>

<p>
With the formatting machinery out of the way,
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3807765"><div id='formatter imports'>&langle;<span class='noweb-def' id='formatter imports-37516'>formatter imports</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">import</span> getopt
  <span class="org-keyword">import</span> sys
  <span class="org-keyword">import</span> sudoku <span class="org-keyword">as</span> sd</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org3f7fda5"><div id='formatter functions-37645'>&langle;<a href='#formatter functions' class='noweb-ref'>formatter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#formatter functions-37084'>&uarr;</a></span></div>  <span class="org-keyword">def</span> <span class="org-function-name">main</span>(argv):
      <span class="org-keyword">try</span>:
          <span class="org-variable-name">opts_</span>, <span class="org-variable-name">args</span> = getopt.gnu_getopt(argv, <span class="org-string">'hp'</span>)
          <span class="org-variable-name">special</span> = {<span class="org-builtin">int</span>(cell) <span class="org-keyword">for</span> cell <span class="org-keyword">in</span> args}
      <span class="org-keyword">except</span> getopt.GetoptError: sys.<span class="org-constant">exit</span>(usage())
      <span class="org-keyword">except</span> <span class="org-type">ValueError</span>: sys.<span class="org-constant">exit</span>(usage())
  
      <span class="org-variable-name">opts</span> = <span class="org-builtin">dict</span>(opts_)
      <span class="org-variable-name">pencil_marks</span> = <span class="org-string">'-p'</span> <span class="org-keyword">in</span> opts
  
      <span class="org-keyword">try</span>:
          <span class="org-variable-name">bd</span> = sd.load_board(sys.stdin.read(), validate_vals=<span class="org-constant">False</span>)
      <span class="org-keyword">except</span> <span class="org-type">ValueError</span>:
          sys.<span class="org-constant">exit</span>(<span class="org-string">'ill-formed board'</span>)
  
      <span class="org-variable-name">not_special</span> = <span class="org-builtin">set</span>(special) &amp; <span class="org-builtin">set</span>(bd.known)
      <span class="org-keyword">if</span> not_special:
          <span class="org-keyword">print</span>(<span class="org-string">"Won't hightlight known cells"</span>, not_special, <span class="org-builtin">file</span>=sys.stderr)
          <span class="org-constant">exit</span>(1)
  
      <span class="org-keyword">print</span>(sudoku_env(bd, pencil_marks, special))</pre>
</div>

<p>
Since we&rsquo;re not attempting to generate solutions, it is not critical that input
boards be restricted in their cell values. Setting <code>validate_vals</code> to <code>False</code>
gives the flexibility needed for such things as illustrations of the division
memberships.
</p>
</div>
</div>

<div id="outline-container-orgf7bf23b" class="outline-4">
<h4 id="orgf7bf23b"><span class="section-number-4">6.3.2</span> The Latex Package</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
Latex has had for years a package for formatting Sudoku boards, but it
focuses purely on the classic 9&times;9 grid. To get around this, we can create a
package of our own that redefines the <code>sudoku</code> environment to deal with
boards of any order.
</p>

<div class="org-src-container">
<pre class="src src-latex" id="orgfc7c9e5"><div id='latex sudoku definitions'>&langle;<span class='noweb-def' id='latex sudoku definitions-38838'>latex sudoku definitions</span>&rangle; &equiv; <span class='chunk-chain'><a href='#latex sudoku definitions-40085'>&darr;</a></span></div>  <span class="org-keyword">\renewenvironment</span>{<span class="org-function-name">sudoku</span>}[1][3]{
    <span class="org-keyword">\newcount\order</span>
    <span class="org-keyword">\order</span> = #1
    <span class="org-keyword">\newcount\n</span>
    <span class="org-keyword">\n</span> = <span class="org-keyword">\numexpr</span>(#1*#1)
    <span class="org-keyword">\FPeval</span>{<span class="org-keyword">\sudodelta</span>}{1/#1/#1}
  
    <span class="org-keyword">\renewenvironment</span>{<span class="org-function-name">sudoku-block</span>}{
      <span class="org-keyword">\catcode</span>`<span class="org-keyword">\|</span>=<span class="org-keyword">\active</span>
      <span class="org-keyword">\@sudoku@activate</span>
      <span class="org-keyword">\setcounter</span>{<span class="org-variable-name">@sudoku@col</span>}{-1}
      <span class="org-keyword">\setcounter</span>{<span class="org-variable-name">@sudoku@row</span>}{<span class="org-keyword">\numexpr</span>(<span class="org-keyword">\n</span>-1)}
      <span class="org-keyword">\setlength\unitlength</span>{<span class="org-keyword">\sudodelta\sudokusize</span>}
      <span class="org-keyword">\begin</span>{<span class="org-function-name">picture</span>}(<span class="org-keyword">\n</span>,<span class="org-keyword">\n</span>)
        <span class="org-keyword">\@sudoku@grid\@sudoku@grab@arguments</span>
    }{
      <span class="org-keyword">\end</span>{<span class="org-function-name">picture</span>}
    }
  
    <span class="org-keyword">\renewcommand*</span><span class="org-function-name">\@sudoku@grid</span>{
      <span class="org-keyword">\linethickness</span>{<span class="org-keyword">\sudokuthinline</span>}
      <span class="org-keyword">\multiput</span>(0,0)(1,0){<span class="org-keyword">\numexpr</span>(<span class="org-keyword">\n</span>+1)}{<span class="org-keyword">\line</span>(0,1){<span class="org-keyword">\n</span>}}
      <span class="org-keyword">\multiput</span>(0,0)(0,1){<span class="org-keyword">\numexpr</span>(<span class="org-keyword">\n</span>+1)}{<span class="org-keyword">\line</span>(1,0){<span class="org-keyword">\n</span>}}
      <span class="org-keyword">\linethickness</span>{<span class="org-keyword">\sudokuthickline</span>}
      <span class="org-keyword">\multiput</span>(0,0)(<span class="org-keyword">\order</span>,0){<span class="org-keyword">\numexpr</span>(<span class="org-keyword">\order</span>+1)}{<span class="org-keyword">\line</span>(0,1){<span class="org-keyword">\n</span>}}
      <span class="org-keyword">\multiput</span>(0,0)(0,<span class="org-keyword">\order</span>){<span class="org-keyword">\numexpr</span>(<span class="org-keyword">\order</span>+1)}{<span class="org-keyword">\line</span>(1,0){<span class="org-keyword">\n</span>}}
      <span class="org-keyword">\linethickness</span>{0.5<span class="org-keyword">\sudokuthickline</span>}
      <span class="org-keyword">\put</span>(0,0){<span class="org-keyword">\framebox</span>(0,0){}}
      <span class="org-keyword">\put</span>(<span class="org-keyword">\n</span>,0){<span class="org-keyword">\framebox</span>(0,0){}}
      <span class="org-keyword">\put</span>(0,<span class="org-keyword">\n</span>){<span class="org-keyword">\framebox</span>(0,0){}}
      <span class="org-keyword">\put</span>(<span class="org-keyword">\n</span>,<span class="org-keyword">\n</span>){<span class="org-keyword">\framebox</span>(0,0){}}}
  
    <span class="org-keyword">\begin</span>{<span class="org-function-name">center</span>}
      <span class="org-keyword">\begin</span>{<span class="org-function-name">sudoku-block</span>}
  }{
      <span class="org-keyword">\end</span>{<span class="org-function-name">sudoku-block</span>}
    <span class="org-keyword">\end</span>{<span class="org-function-name">center</span>}
  }</pre>
</div>

<p>
The original <code>\@sudoku@grab@arguments</code> also presumes too much about its
input, which becomes a problem for boards of order 2.
</p>

<div class="org-src-container">
<pre class="src src-latex" id="orgbb90aca"><div id='latex sudoku definitions-40085'>&langle;<a href='#latex sudoku definitions' class='noweb-ref'>latex sudoku definitions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#latex sudoku definitions-38838'>&uarr;</a></span></div>  <span class="org-keyword">\def</span>\<span class="org-function-name">@sudoku@grab@arguments</span>#1.{
    <span class="org-keyword">\scantokens</span>{#1.}}</pre>
</div>

<p>
Now we can assemble these with a bit of boilerplate and dependency
information to form the <a href="latex/sudokuii.sty">finished Latex package</a>.
</p>

<div class="org-src-container">
<pre class="src src-latex" id="orgc42e386"><div id='latex/sudokuii.sty'>&langle;<span class='noweb-def' id='latex/sudokuii.sty-40372'>latex/sudokuii.sty</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">\NeedsTeXFormat</span>{LaTeX2e}[1999/12/01]
  <span class="org-keyword">\ProvidesPackage</span>{sudokuii}[2020/04/18 Big Sudoku]
  
  <span class="org-keyword">\RequirePackage</span>{sudoku}
  <span class="org-keyword">\RequirePackage</span>{fp}
  
  <span class="org-string">&langle;<a class='noweb-ref' href='#latex sudoku definitions'>latex sudoku definitions</a>&rangle;</span>
  
  <span class="org-keyword">\endinput</span></pre>
</div>
</div>
</div>

<div id="outline-container-org76b4ebf" class="outline-4">
<h4 id="org76b4ebf"><span class="section-number-4">6.3.3</span> Converting Boards to Images</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
We can streamline board formatting a bit more. The output of <code>sudoku2tex</code>
is meant to be combined with <code>sudokuii.sty</code> in a Latex document, which would
then be converted to some convenient format. Let&rsquo;s assume that that format
will be transparent PNG. The overall structure of the image converter will be
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgc2eecd1"><div id='bin/sudoku2img'>&langle;<span class='noweb-def' id='bin/sudoku2img-40991'>bin/sudoku2img</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  &langle;<a class='noweb-ref' href='#image converter functions'>image converter functions</a>&rangle;
  &langle;<a class='noweb-ref' href='#handle image converter arguments'>handle image converter arguments</a>&rangle;
  <span class="org-sh-heredoc">&langle;<a class='noweb-ref' href='#image converter dispatch'>image converter dispatch</a>&rangle;</span></pre>
</div>

<p>
with the following usage:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="org84d2ab9"><div id='image converter functions'>&langle;<span class='noweb-def' id='image converter functions-41194'>image converter functions</span>&rangle; &equiv; <span class='chunk-chain'><a href='#image converter functions-42119'>&darr;</a></span></div>  <span class="org-keyword">function</span> <span class="org-function-name">usage</span>() {
      cat &lt;&lt;EOF
  <span class="org-sh-heredoc">Usage: `basename $0` [OPTIONS]</span>
  <span class="org-sh-heredoc">Generate images from Sudoku boards or puzzles (i.e., paired boards and</span>
  <span class="org-sh-heredoc">solutions, as produced by sudokugen).</span>
  
  <span class="org-sh-heredoc">Options</span>
  <span class="org-sh-heredoc">  -h, --help  print this help and exit</span>
  
  <span class="org-sh-heredoc">  -P OUTDIR   generate images for a puzzle. Expected input is of the form</span>
  <span class="org-sh-heredoc">              produced by sudokugen. At conclusion, OUTDIR will contain:</span>
  
  <span class="org-sh-heredoc">                - new.png       the unsolved board</span>
  <span class="org-sh-heredoc">                - solved.png    the completed board</span>
  <span class="org-sh-heredoc">                - penciled.png  the unsolved board with pencil marks applied</span>
  <span class="org-sh-heredoc">                - input.txt     the original input</span>
  
  <span class="org-sh-heredoc">  --          indicates the end of options for `basename $0`; any remaining </span>
  <span class="org-sh-heredoc">              arguments will be passed to sudoku2tex</span>
  
  <span class="org-sh-heredoc">Input is taken from STDIN.</span>
  <span class="org-sh-heredoc">EOF</span>
  }</pre>
</div>

<p>
Let&rsquo;s begin by wrapping the invocation of <code>pdflatex</code> into something we can
use in a pipeline:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgb3f6069"><div id='image converter functions-42119'>&langle;<a href='#image converter functions' class='noweb-ref'>image converter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#image converter functions-41194'>&uarr;</a><a href='#image converter functions-42843'>&darr;</a></span></div>  <span class="org-keyword">function</span> <span class="org-function-name">pipetex</span>() {
      <span class="org-variable-name">d</span>=<span class="org-sh-quoted-exec">`mktemp -d`</span>
      <span class="org-builtin">pushd</span> $<span class="org-variable-name">d</span> &gt;/dev/null
      {
          cat &lt;&lt;<span class="org-string">'EOF'</span> &gt; sudokuii.sty
  <span class="org-sh-heredoc"> &langle;<a class='noweb-ref' href='#latex/sudokuii.sty'>latex/sudokuii.sty</a>&rangle;</span>
  <span class="org-sh-heredoc">EOF</span>
          pdflatex --jobname tmp &gt;/dev/null
          [[ -f tmp.pdf ]] &amp;&amp; cat tmp.pdf
      }
      <span class="org-builtin">popd</span> &gt; /dev/null
      rm -rf $<span class="org-variable-name">d</span>
  }</pre>
</div>

<p>
Including the contents of <code>sudokuii.sty</code> in this way ensures that we always
have a copy on hand for this application, regardless of what happens on the
wider system. It also side-steps any issues that might arise from installing
in a non-<code>/usr</code> prefix, having a misconfigured <code>TEXINPUTS</code>, etc.
</p>

<p>
With <code>pipetex</code> defined, we can express conversion of the Latex for a single
board:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="org06109b4"><div id='image converter functions-42843'>&langle;<a href='#image converter functions' class='noweb-ref'>image converter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#image converter functions-42119'>&uarr;</a><a href='#image converter functions-43442'>&darr;</a></span></div>  <span class="org-keyword">function</span> <span class="org-function-name">topng</span>() { convert - -trim -transparent white -colorspace RGB png:-; }
  
  <span class="org-keyword">function</span> <span class="org-function-name">tex2png</span>() {
      cat &lt;&lt;EOF | pipetex | topng
  <span class="org-sh-heredoc">\documentclass[border=2pt,varwidth=\maxdimen]{standalone}</span>
  <span class="org-sh-heredoc">\usepackage{graphics}</span>
  <span class="org-sh-heredoc">\usepackage{sudokuii}</span>
  <span class="org-sh-heredoc">\usepackage{xcolor}</span>
  <span class="org-sh-heredoc">\usepackage{tcolorbox}</span>
  
  <span class="org-sh-heredoc">\begin{document}</span>
  <span class="org-sh-heredoc">\begin{varwidth}{\linewidth}</span>
  <span class="org-sh-heredoc">\huge</span>
  <span class="org-sh-heredoc">$(</span><span class="org-sh-quoted-exec">cat</span><span class="org-sh-heredoc">)</span>
  <span class="org-sh-heredoc">\end{varwidth}</span>
  <span class="org-sh-heredoc">\end{document}</span>
  <span class="org-sh-heredoc">EOF</span>
  }</pre>
</div>

<p>
which then becomes a building block for the functionality we ultimately care
about:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="org5926302"><div id='image converter functions-43442'>&langle;<a href='#image converter functions' class='noweb-ref'>image converter functions</a>&rangle; +&equiv; <span class='chunk-chain'><a href='#image converter functions-42843'>&uarr;</a></span></div>  <span class="org-keyword">function</span> <span class="org-function-name">convert_puzzle</span>() {
      <span class="org-variable-name">infile</span>=$<span class="org-variable-name">1</span>
      <span class="org-variable-name">outd</span>=$<span class="org-variable-name">2</span>
      <span class="org-builtin">shift</span> 2
  
      mkdir -p $<span class="org-variable-name">outd</span>
      cp $<span class="org-variable-name">infile</span> $<span class="org-variable-name">outd</span>/input.txt
      egrep    <span class="org-string">'&gt;'</span>    $<span class="org-variable-name">infile</span> | sudoku2tex <span class="org-string">"$@"</span>    | tex2png &gt; $<span class="org-variable-name">outd</span>/solved.png
      egrep -v <span class="org-string">'[:&gt;]'</span> $<span class="org-variable-name">infile</span> | sudoku2tex <span class="org-string">"$@"</span>    | tex2png &gt; $<span class="org-variable-name">outd</span>/new.png
      egrep -v <span class="org-string">'[:&gt;]'</span> $<span class="org-variable-name">infile</span> | sudoku2tex -p <span class="org-string">"$@"</span> | tex2png &gt; $<span class="org-variable-name">outd</span>/penciled.png
  }
  
  <span class="org-keyword">function</span> <span class="org-function-name">convert_board</span>() {
      sudoku2tex <span class="org-string">"$@"</span> | tex2png
  }</pre>
</div>

<p>
Once we deal with the command line arguments
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgc5cda89"><div id='handle image converter arguments'>&langle;<span class='noweb-def' id='handle image converter arguments-43968'>handle image converter arguments</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">while</span> [[ <span class="org-string">"$1"</span> ]]; <span class="org-keyword">do</span>
      <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
          -h|--help)
              usage
              <span class="org-keyword">exit</span> 0
              ;;
          -P)
              <span class="org-builtin">shift</span>
              <span class="org-variable-name">outd</span>=<span class="org-string">"$1"</span>
              <span class="org-variable-name">problem</span>=1
              <span class="org-keyword">if</span> <span class="org-negation-char">!</span> [[ <span class="org-string">"$outd"</span> ]]; <span class="org-keyword">then</span>
                  <span class="org-builtin">echo</span> <span class="org-string">"'-P' requires output directory"</span>
                  usage
                  <span class="org-keyword">exit</span> 1
              <span class="org-keyword">fi</span>
              ;;
          --)
              <span class="org-builtin">shift</span>
              <span class="org-keyword">break</span>
              ;;
          *)
              <span class="org-builtin">echo</span> unknown option <span class="org-string">"'$1'"</span>
              usage
              <span class="org-keyword">exit</span> 1
              ;;
      <span class="org-keyword">esac</span>
      <span class="org-builtin">shift</span>
  <span class="org-keyword">done</span></pre>
</div>

<p>
we can get on with dispatching to the proper conversion routine:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgceba6d6"><div id='image converter dispatch'>&langle;<span class='noweb-def' id='image converter dispatch-44456'>image converter dispatch</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-variable-name">tmpfile</span>=<span class="org-sh-quoted-exec">`mktemp`</span>
  cat &gt; $<span class="org-variable-name">tmpfile</span>
  <span class="org-variable-name">err</span>=0
  
  <span class="org-keyword">if</span> [[ <span class="org-string">"$problem"</span> ]]; <span class="org-keyword">then</span>
      convert_puzzle $<span class="org-variable-name">tmpfile</span> $<span class="org-variable-name">outd</span> <span class="org-string">"$@"</span>
  <span class="org-keyword">elif</span> grep -q difficulty $<span class="org-variable-name">tmpfile</span>; <span class="org-keyword">then</span>
      <span class="org-builtin">echo</span> <span class="org-string">'sudokugen output detected; re-run with -P option.'</span> &gt;&amp;2
      <span class="org-variable-name">err</span>=1
  <span class="org-keyword">else</span>
      &lt;$<span class="org-variable-name">tmpfile</span> convert_board <span class="org-string">"$@"</span>
  <span class="org-keyword">fi</span>
  
  rm -f $<span class="org-variable-name">tmpfile</span>
  <span class="org-keyword">exit</span> $<span class="org-variable-name">err</span></pre>
</div>

<p>
At this point, generating a large Sudoku is as simple as
</p>

<pre class="example">
sudokugen -o 5 -m -g2 | sudoku2img -P foo

</pre>

<p>
Now we have something to occupy a good bit of time:
</p>


<div class="figure">
<p><img src="images/5x5/new.png" alt="new.png" />
</p>
</div>

<p>
And, when we finally give up, here&rsquo;s the solution:
</p>


<div class="figure">
<p><img src="images/5x5/solved.png" alt="solved.png" />
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org948873e" class="outline-2">
<h2 id="org948873e"><span class="section-number-2">7</span> Putting It All Together</h2>
<div class="outline-text-2" id="text-7">
<p>
There&rsquo;s just one more item to make this into a usable package.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org8ce7f21"><div id='setup.py'>&langle;<span class='noweb-def' id='setup.py-45225'>setup.py</span>&rangle; &equiv; <span class='chunk-chain'></span></div>  <span class="org-keyword">import</span> os
  <span class="org-keyword">from</span> setuptools <span class="org-keyword">import</span> setup, find_packages
  
  <span class="org-keyword">def</span> <span class="org-function-name">ls</span>(base):
      <span class="org-keyword">return</span> [os.path.join(base, fn) <span class="org-keyword">for</span> fn <span class="org-keyword">in</span> os.listdir(base)]
  
  setup(name=<span class="org-string">'sudoku'</span>,
        version=<span class="org-string">'0.1'</span>,
        description=<span class="org-string">'Sudoku'</span>,
        packages=find_packages(),
        scripts=ls(<span class="org-string">'bin'</span>),
        zip_safe=<span class="org-constant">False</span>)</pre>
</div>

<p>
Now installation is a simple
</p>

<pre class="example">
./setup.py install

</pre>

<p>
away.
</p>
</div>
</div>

<div id="outline-container-org16c1760" class="outline-2">
<h2 id="org16c1760"><span class="section-number-2">8</span> Performance</h2>
<div class="outline-text-2" id="text-8">
<p>
With all the work we&rsquo;ve put in, how well does all of this perform? Let&rsquo;s go by
major use-case.
</p>
</div>

<div id="outline-container-org7d15ae2" class="outline-3">
<h3 id="org7d15ae2"><span class="section-number-3">8.1</span> Generating Puzzles</h3>
<div class="outline-text-3" id="text-8-1">
<p>
The following depicts the run time distributions for creating puzzles, via
<code>sudokugen</code>, of orders 2&#x2013;5, with <code>maxguesses</code> varying in &omega; steps from 0
to \(\omega^2\). Each pairing was run 100 times, and each run was capped at 300
seconds of real time.
</p>


<div class="figure">
<p><img src="./images/gentime.png" alt="gentime.png" />
</p>
</div>

<p>
As a practical matter, <code>maxguesses</code> doesn&rsquo;t seem to matter until order 5, at
least for performance. At order 5, though, once we allow 10 or more guesses,
generation time ramps up very quickly. (As a practical matter, though,
<code>maxguesses</code> is key to ensuring that humans can handle larger boards
manually.) We can get an alternate perspective by looking at how the mix of
job results varies:
</p>


<div class="figure">
<p><img src="./images/genstat.png" alt="genstat.png" />
</p>
</div>

<p>
The explosion in generation time shows here in the growth of job timeouts. We
can also see the effect that <code>maxguesses</code> has on our ability to ensure that a
generated board is proper.
</p>
</div>
</div>

<div id="outline-container-orgcc2e551" class="outline-3">
<h3 id="orgcc2e551"><span class="section-number-3">8.2</span> Solving</h3>
<div class="outline-text-3" id="text-8-2">
<p>
The generation test produced a total of 1438 proper boards. Solving each
gives the following distribution of runtimes vs. generation parameters:
</p>


<div class="figure">
<p><img src="./images/solvetime.png" alt="solvetime.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org35b795b" class="outline-2">
<h2 id="org35b795b"><span class="section-number-2">9</span> Wrapping Up</h2>
<div class="outline-text-2" id="text-9">
<p>
The library that implements all of the core logic for generating, solving,
parsing, and serializing boards weighs in at 258 lines, excluding blanks; the
command line tools, 363 lines. There is much, much more that we could do:
</p>

<ul class="org-ul">
<li>We could create related tools that, rather than assuming the nested-grid
structure that we&rsquo;ve been enforcing so far, instead read the cell/division
structure from a file, allowing us to lean on both the generation and
solution logic for nearly arbitrary board arrangements (like Squiggly Sudoku
or Jigsaw Sudoku).</li>
<li>We could implement more strategies for solving puzzles, and then build out
machinery for tracking which get used, allowing us to more meaningfully
estimate difficulty.</li>
<li>We could rework the formatting tools to jettison the dependence on Latex and
ImageMagick.</li>
<li>We could lavish attention on performance.</li>
</ul>

<p>
But there&rsquo;s little reason. Now that we know how to generate and solve
basically anything that is recognizably a Sudoku board, we can consider
ourselves free to think of <a href="https://en.wikipedia.org/wiki/NP-completeness">other</a> problems, like <a href="https://en.wikipedia.org/wiki/Register_allocation#Graph-coloring_allocation">register allocation</a> and <a href="https://en.wikipedia.org/wiki/Job_shop_scheduling">job
scheduling</a>. 
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<hr style='height:0.5px'>
<small>R E I N D E E R E F F E C T</small>
</div>
</body>
</html>
